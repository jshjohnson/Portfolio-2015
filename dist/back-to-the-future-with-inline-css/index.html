<!DOCTYPE html><!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>Back to the future - Inlining CSS - Josh Johnson - Front-end Developer</title><meta name=description itemprop=description content="Performance enhancing our websites and web-apps by avoiding render blocking and inlining our critical CSS."><meta name=viewport content="width=device-width,initial-scale=1,minimal-ui"><meta name=twitter:site content=@jshjohnson><meta name=twitter:creator content=@jshjohnson><meta name=twitter:title content="Back to the future - Inlining CSS"><meta name=twitter:description content="Performance enhancing our websites and web-apps by avoiding render blocking and inlining our critical CSS."><meta itemprop=name content="Back to the future - Inlining CSS"><meta itemprop=description content="Performance enhancing our websites and web-apps by avoiding render blocking and inlining our critical CSS."><!--[if !IE]><!--><link rel=stylesheet href=/assets/css/screen.css media=screen><!--<![endif]--><!--[if (lt IE 9) & (!IEMobile)]><link rel="stylesheet" href="/assets/css/ie.css" media="screen">
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><![endif]--><link rel=apple-touch-icon sizes=57x57 href=/assets/img/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/assets/img/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/assets/img/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/assets/img/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/assets/img/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/assets/img/apple-touch-icon-120x120.png><link rel=icon type=image/png href=/assets/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/img/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/img/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/img/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=theme-color content=#ffffff></head><body><header class=header id=top><div class="container container--relative"><div class=grid><div class="intro grid__cell unit-1-2--bp2"><h1 class=intro__heading><a href="/">Joshua Johnson</a></h1><h2 class=intro__subheading>Front-end Dev Lead @ <a href=http://browserlondon.com class=intro__link>Browser London</a></h2></div><nav class="nav nav--primary grid__cell unit-1-2--bp2"><ul class=nav__list><li class="nav__item nav__item--active"><a href="/" class=nav__link>Blog</a></li><li class=nav__item><a href=https://twitter.com/jshjohnson class=nav__link>Twitter</a></li></ul></nav></div></div></header><main class=post><div class=container><div class="grid text-center"><article class="post__item post__item--single grid__cell unit-3-5--bp4 unit-3-4--bp3"><header class=post__header><time datetime="2015-08-29 10:00:00 +0100" class=post__date>29th August 2015</time><h1 class=post__heading>Back to the future - Inlining CSS</h1><a href="http://twitter.com/share?text=Back to the future - Inlining CSS&url=" class=ribbon><img src=/assets/img/share.svg class=ribbon__inner></a></header><div class=post__wrapper><p><span class=drop-cap><span class=drop-cap__inner>W</span></span>ith the fervour of responsive web design subsiding, us front-end developers have finally begun to discuss and debate how we might actually make the websites we produce, er, responsive.</p><p>Regardless of whether your beautiful new website caresses it’s users with thoughtful interface design; if it <a title="Loading time" href="https://blog.kissmetrics.com/loading-time/" target=_blank>does not load within a second</a>, your users will experience a lag that leads to impatience and often frustration –&nbsp;not something we should be aiming for, especially at a time where the popularity, proximity and fluidity of native applications is overshadowing the advancements coming to the web.</p><p>So putting latency aside&nbsp;–&nbsp;a delay relating to the server,&nbsp;what can front-end developers do to performance enhance our websites and web applications?</p><p>Or put another way, how we can achieve the transition below (using <a title="Google PageSpeed Insights" href="https://developers.google.com/speed/pagespeed/insights/" target=_blank>Google PageSpeed</a>&nbsp;as a benchmarking tool) on the websites we release into the wild?</p><p><img alt="Google page speed comparison" src=/assets/img/google-page-speed-test.jpg width=748 height=160></p><div><h2>Inlining critical CSS</h2><p>It may sound strange to hear “inlining” cropping up as a suggestion in a blog post related to front-end development, as we have spent the past few years conditioning ourselves to detach our CSS and JavaScript from our HTML. Attempting to compete with the the responsiveness and immediacy of native applications however requires us to to break some previously well-intentioned rules.</p><p>To understand the benefits of inlining CSS into our HTML, it’s important firstly to know <em>why</em> loading CSS in an external stylesheet can in fact be slowing us down. To avoid continuous re-painting, browsers will <a title="Render blocking CSS" href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css?hl=en" target=_blank>block rendering</a> of your page until all CSS has been loaded. You may have noticed that web designers often discuss FOUT (flashing of un-styled text), but you will rarely (if ever) hear discussions regarding un-styled content being presented to users – this is because&nbsp;browsers decide the rendering path for us whereas fonts do not.</p><p>For small websites this may be exactly what you wish to happen, however for the the majority of websites, there is no real necessity to load&nbsp;<em>all</em> of your stylesheet when a user first visits your website; their time is precious and we need to respect that. Luckily, we can resolve this with, yes you’ve guessed it, inlining our <em>critical</em> CSS to improve our site’s first render speed.</p><p>By inlining critical CSS (namely&nbsp;areas such as grid, header and logo styling) in the head of our HTML, the browser is no longer required to immediately download a large external CSS file and can therefore render our site faster to users. Once the page has initially rendered, we can then asynchronously load our full stylesheet behind the scenes, so by the time a user is ready to interact with your website, remaining styles further down the page have been painted by the browser.</p><p>Taking this step further, we can set a cookie when we first&nbsp;asynchronously load our full stylesheet to identify whether the full CSS file is cached by the browser and can therefore identify whether to load the stylesheet conventionally or via the inline method.</p><p>Using PHP as an example (not a requirement), this will look something like this in the head of your HTML:</p><pre class="pre pre--overflow"><code>&lt;?php
    // Asset version number - change when CSS needs updating
    $version = '20150829'; 

    // If cookie has been set and matches the version above, load CSS normally
    if (!empty( $_COOKIE[ 'csscached' ]) &amp;&amp; $_COOKIE[ 'csscached' ] === $version) :
?&gt;
    &lt;link rel="stylesheet" href="/assets/styles/main.min.css?v=&lt;?php echo $version;?&gt;"&gt;
&lt;?php 
    else : 
?&gt;
    &lt;style&gt;
        &lt;?php include 'critical-css.php'; ?&gt;
    &lt;/style&gt;
    &lt;script&gt;
        /*!
            loadCSS: load a CSS file asynchronously.
            [c]2014 @scottjehl, Filament Group, Inc.
            Licensed MIT
        */
        function loadCSS(e,t,n,r){...};
        function onloadCSS(e,t){...};

        var ss = loadCSS( "/assets/styles/main.min.css?v=&lt;?php echo $version;?&gt;" );

        onloadCSS(ss, function() {
            var root = document.documentElement;

            // Add class to HTML element when full stylesheet has downloaded
            root.className += " full-css";

            if (root.classList) {
                // For modern browsers, remove the 'no-full-css' class (set on the HTML element) the modern way
                root.classList.remove('no-full-css');
            } else {
                // Otherwise remove the 'no-full-css' class the archaic way
                rootclassName = root.className.replace(new RegExp('(^|\\b)' + no-full-css.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
            }
        });

        // Set cookie with far expiry date after first load
        document.cookie = 'csscached=&lt;?php echo $version;?&gt;;expires="Wed, 20 Jan 2040 10:20:10 GMT";path=/';
    &lt;/script&gt;

    // Load stylesheet conventionally for users with JavaScript switched off
    &lt;noscript&gt;
        &lt;link rel="stylesheet" href="/assets/styles/main.min.css?v=&lt;?php echo $version;?&gt;"&gt;
    &lt;/noscript&gt;
&lt;?php 
    endif;
?&gt;</code></pre><p>Not only does this method increase the psuedo-performance of our website for users, it also has the added benefit of ensuring we keep our CSS modular. If you can easily include specific modules from your main stylesheet into a critical CSS file without your site’s structure and fundamental appearance breaking due to an over-reliance on the CSS cascade, you’re in a good position to inline your CSS.</p><p>If you are already equipped and accustomed to task runners within your development workflow, this approach can also be easily integrated using the following tools:</p><ul><li><a title="Grunt Critical CSS" href=https://github.com/filamentgroup/grunt-criticalcss target=_blank>Critical CSS</a> (Grunt)</li><li><a title="Critical NPM" href="https://github.com/addyosmani/critical?utm_source=designernews" target=_blank>Critical</a>&nbsp;(npm)</li><li><a title=loadCSS href="https://github.com/filamentgroup/loadCSS/" target=_blank>loadCSS</a></li></ul><h2>The future is bright</h2><p>Fortunately with HTTP2 coming to the web in the near distant future and the changes that poses to the rendering path&nbsp;–&nbsp;especially the ability to conditionally load CSS without the performance hindrance of multiple HTTP requests –&nbsp;this method will become obsolete and once again the browser will be more competitive with the native-app industry. Combined with the offerings of <a title="Service Worker" href="http://www.html5rocks.com/en/tutorials/service-worker/introduction/" target=_blank>Service Worker</a>&nbsp;and the affordances of a more controllable cache, CSS will eventually pose far less of an issue in relation to the page-rendering speed of websites, meaning the speed to which our users can read the content they came for will only improve with time. Until then, inlining CSS is back on the menu!</p><p>In action:&nbsp;<a title="Twine Intranet" href="http://www.twineintranet.com/" target=_blank>Twine Intranet</a></p><p>Further viewing:&nbsp;<a title="Patrick Hamann: CSS and the Critical Path" href="https://www.youtube.com/watch?v=_0Fk85to6hA" target=_blank>Patrick Hamann – CSS and the Critical Path</a></p><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname="joshjohnsonportfolio",disqus_identifier="/back-to-the-future-with-inline-css";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script></div></div></article></div></div></main><script type=text/javascript async>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-31575166-1"]),_gaq.push(["_setDomainName","joshuajohnson.co.uk"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(t,a)}();</script></body></html>